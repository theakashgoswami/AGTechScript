let ALL_FAQS=[],AI_KNOWLEDGE=[],BLOG_POSTS_CACHE=null;function initAIAssistant(){let t=document.getElementById("aiFloatingBtn"),e=document.getElementById("aiPopupWindow"),s=document.getElementById("aiCloseBtn"),n=document.getElementById("aiSend"),i=document.getElementById("aiInput");t&&e&&(t.addEventListener("click",function(t){t.preventDefault(),t.stopPropagation(),e.classList.toggle("active"),e.classList.contains("active")&&loadFAQs()}),s&&s.addEventListener("click",()=>{e.classList.remove("active")}),i&&i.addEventListener("click",function(){this.focus()}),n&&n.addEventListener("click",function(t){t.preventDefault(),t.stopPropagation(),handleAIQuestion()}),i&&(i.addEventListener("keypress",function(t){"Enter"===t.key&&(t.preventDefault(),handleAIQuestion())}),i.addEventListener("input",function(){let t=this.value.trim();t.length>0?showPostSuggestions(t):loadAISuggestions()})),document.addEventListener("click",function(t){!t.target.closest(".ai-popup-window")&&!t.target.closest(".ai-floating-btn")&&e.classList.contains("active")&&e.classList.remove("active")}))}async function loadFAQs(){try{let t=await fetch("https://docs.google.com/spreadsheets/d/12LdHpXyaV32tc4gZaDz8yawfsvSv_sA1-tlx0tzmHvc/gviz/tq?tqx=out:json"),e=await t.text(),s=e.match(/google\.visualization\.Query\.setResponse\(({.*})\);/);if(!s)throw Error("Invalid response");let n=JSON.parse(s[1]),i=n.table.rows||[];AI_KNOWLEDGE=(ALL_FAQS=i.map(t=>({question:t.c&&t.c[0]&&t.c[0].v||"",answer:t.c&&t.c[1]&&t.c[1].v||"",tags:t.c&&t.c[2]?(t.c[2].v||"").toLowerCase().split(",").map(t=>t.trim()).filter(t=>t):[]})).filter(t=>""!==t.question.trim())).map(t=>({question:t.question.toLowerCase(),answer:t.answer,tags:t.tags})),setupChat(),loadAISuggestions()}catch(a){console.error("FAQ Load Error:",a),AI_KNOWLEDGE=(ALL_FAQS=[{question:"How to contact support?",answer:"Email: support@agtechscript.in",tags:["support","contact"]},{question:"What is your refund policy?",answer:"30-day money back guarantee.",tags:["refund","payment"]},{question:"How to reset password?",answer:"Go to Settings > Security > Reset Password.",tags:["password","security"]}]).map(t=>({question:t.question.toLowerCase(),answer:t.answer,tags:t.tags})),setupChat(),loadAISuggestions()}}function setupChat(){}function loadAISuggestions(){let t=document.getElementById("suggestionChips");if(!t)return;if(0===ALL_FAQS.length){t.innerHTML="<div class='suggestion-chip'>Loading...</div>";return}let e=[...ALL_FAQS].sort(()=>.5-Math.random()).slice(0,6),s=["\uD83E\uDD14","\uD83D\uDCAD","‚ùì","‚ú®","\uD83D\uDD0D","\uD83D\uDCA1","\uD83C\uDFAF"];t.innerHTML=e.map(t=>{let e=s[Math.floor(Math.random()*s.length)],n=t.question.length>35?t.question.substring(0,35)+"...":t.question;return`<div class="suggestion-chip" data-question="${t.question.replace(/"/g,"&quot;")}">${e} ${n}</div>`}).join(""),document.querySelectorAll(".suggestion-chip[data-question]").forEach(t=>{t.addEventListener("click",()=>{let e=document.getElementById("aiInput");e&&(e.value=t.getAttribute("data-question"),handleAIQuestion())})})}async function showPostSuggestions(t){let e=document.getElementById("suggestionChips");if(!e)return;if(t.length<2){loadAISuggestions();return}let s=await searchPostsFromBlog(t),n=findMatchingFAQs(t),i=[...s,...n].slice(0,6);0===i.length?e.innerHTML='<div class="suggestion-chip no-hover">No matches</div><div class="suggestion-chip" onclick="loadAISuggestions()">‚¨ÖÔ∏è Back</div>':(e.innerHTML=i.map(t=>"post"===t.type?`<div class="suggestion-chip" data-url="${t.url}">üìù ${t.title}</div>`:`<div class="suggestion-chip" data-question="${t.question.replace(/"/g,"&quot;")}">üí° ${t.question}</div>`).join(""),document.querySelectorAll(".suggestion-chip[data-url]").forEach(t=>{t.addEventListener("click",()=>{window.open(t.getAttribute("data-url"),"_blank")})}),document.querySelectorAll(".suggestion-chip[data-question]").forEach(t=>{t.addEventListener("click",()=>{let e=document.getElementById("aiInput");e&&(e.value=t.getAttribute("data-question"),handleAIQuestion())})}))}function findMatchingFAQs(t){let e=t.toLowerCase().split(/\s+/).filter(t=>t.length>2);return ALL_FAQS.map(t=>{let s=0,n=(t.question+" "+t.tags.join(" ")).toLowerCase();return e.forEach(t=>{n.includes(t)&&s++}),{...t,score:s,type:"faq"}}).filter(t=>t.score>0).sort((t,e)=>e.score-t.score).slice(0,3)}async function handleAIQuestion(){let t=document.getElementById("aiInput"),e=t.value.trim();e&&(addAIMessage(e,!0),t.value="",showTyping(),setTimeout(async()=>{let t=await findAIResponse(e);hideTyping(),addAIMessage(t),loadAISuggestions()},700))}async function findAIResponse(t){let e=t.toLowerCase().trim(),s="",n=0,i=null;if(AI_KNOWLEDGE.forEach(t=>{let s=0,a=e.split(/\s+/).filter(t=>t.length>2);e===t.question&&(s=100),a.forEach(e=>{t.question.includes(e)&&(s+=3),t.tags.forEach(t=>{(t.includes(e)||e.includes(t))&&(s+=2)})}),s>n&&(n=s,i=t)}),i&&n>=3&&(s+=`<div class="faq-answer">${i.answer}</div>`),!s){let a=await searchPostsFromBlog(e),o=a.filter(t=>t.score>=2);o.length>0&&(s+='<div class="related-posts"><strong>Related Articles:</strong><br>',o.forEach(t=>{s+=`<a href="${t.url}" target="_blank">‚Ä¢ ${t.title}</a><br>`}),s+="</div>")}if(!s){let l=[...ALL_FAQS].sort(()=>.5-Math.random()).slice(0,3);s="I couldn't find an exact answer. Try these:<br><br>",l.forEach(t=>{s+=`‚Ä¢ <span class="suggestion-link" onclick="document.getElementById('aiInput').value='${t.question}'; handleAIQuestion();">${t.question}</span><br>`})}return s}async function searchPostsFromBlog(t){let e=t.toLowerCase().replace(/[^a-z0-9\s]/g," ").split(/\s+/).filter(t=>t.length>=3).filter(t=>!["what","how","why","when","where","which","who","this","that","these","those","have","has","had","will","would","should","could","can","may","might","must","shall"].includes(t));if(0===e.length)return[];try{if(!BLOG_POSTS_CACHE){let s=await fetch("/feeds/posts/default?alt=json&max-results=100"),n=await s.json(),i=n.feed.entry||[];BLOG_POSTS_CACHE=i.map(t=>{let e=t.link.find(t=>"alternate"===t.rel)?.href||"#",s=(t.category||[]).map(t=>t.term.toLowerCase());return{title:t.title?.$t||"Untitled",url:e,content:(t.content?.$t||t.summary?.$t||"").toLowerCase(),labels:s,titleLower:(t.title?.$t||"").toLowerCase()}})}let a=[],o=new Set;return BLOG_POSTS_CACHE.forEach(t=>{let s=0;e.forEach(e=>{t.titleLower.includes(e)&&(s+=5),t.labels.some(t=>t.includes(e))&&(s+=4),t.content.includes(e)&&(s+=1)}),s>=2&&!o.has(t.url)&&(o.add(t.url),a.push({title:t.title.length>60?t.title.substring(0,60)+"...":t.title,url:t.url,score:s,type:"post"}))}),a.sort((t,e)=>e.score-t.score).slice(0,5)}catch(l){return console.warn("Blog search error:",l),[]}}function addAIMessage(t,e=!1){let s=document.getElementById("aiMessages");if(!s)return;let n=document.createElement("div");n.className=`ai-message ${e?"user":"bot"}`,n.innerHTML=`<p>${t}</p>`,s.appendChild(n),s.scrollTop=s.scrollHeight}function showTyping(){let t=document.getElementById("aiMessages");if(!t)return;let e=document.createElement("div");e.id="typingIndicator",e.className="ai-message bot typing",e.innerHTML='<p>Thinking<span class="typing-dots">...</span></p>',t.appendChild(e),t.scrollTop=t.scrollHeight}function hideTyping(){let t=document.getElementById("typingIndicator");t&&t.remove()}document.addEventListener("DOMContentLoaded",function(){initAIAssistant()}),window.initializeAIAssistant=initAIAssistant;